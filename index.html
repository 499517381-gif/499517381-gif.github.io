<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº¤æ˜“è®¡åˆ’æé†’å·¥å…·</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; }
        body { background-color: #f5f7fa; color: #333; line-height: 1.6; padding: 12px; }
        .container { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; }
        
        /* ä¼˜åŒ–æ ‡é¢˜æ  */
        header { 
            background: linear-gradient(135deg, #1a6dff 0%, #0d4dc2 100%); 
            color: white; 
            padding: 15px; 
            border-radius: 10px; 
            box-shadow: 0 4px 12px rgba(26, 109, 255, 0.2); 
        }
        h1 { 
            font-size: 20px; 
            margin-bottom: 5px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        h1 i { font-size: 24px; }
        .subtitle { 
            opacity: 0.9; 
            font-size: 13px; 
            line-height: 1.4;
        }
        
        /* ä¼˜åŒ–æ§åˆ¶æŒ‰é’®åŒºåŸŸ */
        .app-controls { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            margin-bottom: 5px;
        }
        .btn-row {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .btn-row::-webkit-scrollbar {
            height: 3px;
        }
        .btn-row::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 3px;
        }
        
        /* ä¼˜åŒ–æŒ‰é’®æ ·å¼ */
        .btn-primary, .btn-success {
            padding: 12px 16px !important;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
            font-size: 14px;
            white-space: nowrap;
            min-height: 44px;
            flex: 1;
            min-width: 0;
            border: none;
        }
        .btn-primary { 
            background: #1a6dff; 
            color: white; 
            box-shadow: 0 2px 8px rgba(26, 109, 255, 0.3); 
        }
        .btn-primary:hover { background: #0d5be6; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(26, 109, 255, 0.4); }
        
        .btn-success { 
            background: #4caf50; 
            color: white; 
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3); 
        }
        .btn-success:hover { background: #43a047; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4); }
        .btn-success:disabled { background: #cccccc; cursor: not-allowed; transform: none; box-shadow: none; }
        
        /* ä¼˜åŒ–æ ‡ç­¾é¡µ */
        .tabs { 
            display: flex; 
            background: white; 
            border-radius: 8px; 
            overflow: hidden; 
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); 
        }
        .tab { 
            padding: 12px 10px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s; 
            text-align: center; 
            flex: 1; 
            font-size: 13px;
        }
        .tab.active { background: #1a6dff; color: white; }
        .tab:hover:not(.active) { background: #f0f7ff; }
        
        /* ä¼˜åŒ–æ›´æ–°ä¿¡æ¯ */
        .update-info { 
            display: flex; 
            flex-direction: column;
            align-items: flex-start;
            background: #e8f5e9; 
            padding: 10px 12px; 
            border-radius: 8px; 
            margin-bottom: 10px;
            font-size: 12px;
            gap: 3px;
        }
        .update-info > div {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        /* ä¼˜åŒ–è®¡åˆ’å¡ç‰‡å®¹å™¨ */
        .plans-container { 
            display: flex; 
            flex-direction: column;
            gap: 12px; 
        }
        .plan-card { 
            background: white; 
            border-radius: 10px; 
            overflow: hidden; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.07); 
            transition: transform 0.2s ease, box-shadow 0.2s ease; 
        }
        .plan-card:hover { transform: translateY(-3px); box-shadow: 0 8px 18px rgba(0, 0, 0, 0.1); }
        
        /* ä¼˜åŒ–è®¡åˆ’å¡ç‰‡å¤´éƒ¨ */
        .plan-header { 
            padding: 15px; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
        }
        .stock-info { display: flex; flex-direction: column; flex: 1; }
        .stock-name { font-size: 16px; font-weight: 700; color: #1a1a1a; line-height: 1.2; }
        .stock-code { color: #666; font-size: 12px; margin-top: 2px; }
        .price-info { text-align: right; min-width: 100px; }
        .current-price { font-size: 18px; font-weight: 700; line-height: 1.2; }
        .current-price.unavailable { color: #888; font-size: 14px; }
        .price-update-time { font-size: 11px; color: #888; margin-top: 2px; }
        
        .plan-status { 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-size: 11px; 
            font-weight: 600; 
            margin-top: 8px; 
            display: inline-block; 
            width: fit-content;
        }
        .status-interested { background-color: #f3e5f5; color: #8e24aa; }
        .status-in-progress { background-color: #fff8e1; color: #ff8f00; }
        .status-completed { background-color: #e8f5e9; color: #43a047; }
        
        /* ä¼˜åŒ–è®¡åˆ’å†…å®¹åŒºåŸŸ */
        .plan-content { padding: 15px; }
        .signals-list { margin-top: 10px; }
        .signal-item { 
            padding: 10px 0; 
            border-bottom: 1px dashed #eee; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
        }
        .signal-item:last-child { border-bottom: none; }
        .signal-type { font-size: 12px; font-weight: 600; color: #1a6dff; min-width: 60px; }
        .signal-desc { 
            flex-grow: 1; 
            margin-left: 8px; 
            font-size: 12px; 
            min-width: 120px;
            word-break: break-word;
        }
        .signal-target { font-weight: 600; color: #333; font-size: 12px; }
        .signal-tag { 
            background-color: #e8f5e9; 
            color: #2e7d32; 
            padding: 2px 6px; 
            border-radius: 3px; 
            font-size: 10px; 
            font-weight: 600; 
            margin-left: 5px; 
            white-space: nowrap;
        }
        .signal-tag.time { background-color: #e3f2fd; color: #1565c0; }
        .signal-tag.price { background-color: #fff8e1; color: #ff8f00; }
        
        /* ä¼˜åŒ–è®¡åˆ’æ“ä½œæŒ‰é’® */
        .plan-actions { 
            padding: 12px 15px; 
            background-color: #f9fafc; 
            display: flex; 
            gap: 8px; 
            border-top: 1px solid #eee; 
            flex-wrap: wrap;
        }
        .plan-actions button {
            padding: 8px 12px;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            flex: 1;
            min-width: 70px;
            border: 1px solid;
        }
        .plan-actions .btn-secondary { 
            background: transparent; 
            border-color: #1a6dff; 
            color: #1a6dff; 
        }
        .plan-actions .btn-secondary:hover { background: #1a6dff; color: white; }
        
        .plan-actions .btn-execute { 
            background: transparent; 
            border-color: #ff9800; 
            color: #ff9800; 
        }
        .plan-actions .btn-execute:hover { background: #ff9800; color: white; }
        
        .plan-actions .btn-sell { 
            background: transparent; 
            border-color: #f44336; 
            color: #f44336; 
        }
        .plan-actions .btn-sell:hover { background: #f44336; color: white; }
        
        .plan-actions .btn-history { 
            background: transparent; 
            border-color: #673ab7; 
            color: #673ab7; 
        }
        .plan-actions .btn-history:hover { background: #673ab7; color: white; }
        
        /* ä¼˜åŒ–ç©ºçŠ¶æ€ */
        .empty-state { 
            text-align: center; 
            padding: 40px 15px; 
            color: #888; 
        }
        .empty-state i { font-size: 40px; margin-bottom: 15px; color: #ccc; }
        .empty-state h3 { font-size: 18px; margin-bottom: 8px; color: #666; }
        .empty-state p { font-size: 13px; }
        
        /* ä¼˜åŒ–é¡µè„š */
        footer { 
            text-align: center; 
            margin-top: 20px; 
            color: #888; 
            font-size: 12px; 
            padding-top: 15px; 
            border-top: 1px solid #eee; 
            line-height: 1.5;
        }
        footer p { margin-bottom: 5px; }
        
        /* ä¼˜åŒ–æ¨¡æ€æ¡† */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.5); 
            z-index: 1000; 
            justify-content: center; 
            align-items: center; 
            padding: 15px;
        }
        .modal-content { 
            background-color: white; 
            width: 100%; 
            max-width: 500px; 
            border-radius: 10px; 
            overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); 
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .modal-content.history-modal { max-width: 800px; }
        .modal-header { 
            background: linear-gradient(135deg, #1a6dff 0%, #0d4dc2 100%); 
            color: white; 
            padding: 15px; 
            font-size: 16px; 
            font-weight: 600; 
        }
        .modal-body { 
            padding: 20px; 
            overflow-y: auto; 
            flex-grow: 1; 
        }
        
        /* ä¼˜åŒ–è¡¨å•å…ƒç´  */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #444; font-size: 13px; }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; 
            padding: 10px 12px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            font-size: 14px; 
            transition: border 0.3s; 
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #1a6dff; outline: none; }
        .form-row { display: flex; gap: 10px; flex-direction: column; }
        .form-row .form-group { flex: 1; }
        
        /* ä¼˜åŒ–é€šçŸ¥ */
        .notification { 
            position: fixed; 
            top: 15px; 
            right: 15px; 
            background: #4caf50; 
            color: white; 
            padding: 12px 18px; 
            border-radius: 6px; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.15); 
            z-index: 1000; 
            font-weight: 600; 
            animation: slideIn 0.3s ease; 
            max-width: 300px;
            font-size: 13px;
        }
        
        /* æ•°æ®æºæ ‡è®°æ ·å¼ */
        .data-source-badge {
            font-size: 9px;
            padding: 1px 4px;
            border-radius: 3px;
            margin-left: 5px;
            font-weight: 600;
        }
        .data-source-realtime {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .data-source-unavailable {
            background: #ffebee;
            color: #d32f2f;
        }
        .data-source-initial {
            background: #f5f5f5;
            color: #666;
        }
        
        /* å¹³æ¿å’Œæ¡Œé¢ç«¯é€‚é… */
        @media (min-width: 768px) {
            body { padding: 20px; }
            header { padding: 20px; }
            h1 { font-size: 24px; }
            .subtitle { font-size: 14px; }
            .app-controls { flex-direction: row; }
            .btn-row { flex-wrap: wrap; }
            .btn-primary, .btn-success {
                padding: 12px 24px !important;
                font-size: 14px;
                min-height: 44px;
                flex: none;
            }
            .tab { padding: 15px; font-size: 14px; }
            .plans-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 15px; }
            .form-row { flex-direction: row; }
            .update-info { flex-direction: row; justify-content: space-between; }
        }
        
        /* è¶…å°å±å¹•æ‰‹æœºä¼˜åŒ– */
        @media (max-width: 360px) {
            .btn-primary, .btn-success {
                padding: 10px 12px !important;
                font-size: 13px;
                min-height: 40px;
            }
            .stock-name { font-size: 14px; }
            .current-price { font-size: 16px; }
            .plan-actions { flex-direction: column; }
            .plan-actions button { width: 100%; }
        }
        
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-chart-line"></i> äº¤æ˜“è®¡åˆ’æé†’å·¥å…·</h1>
            <p class="subtitle">å®æ—¶è‚¡ä»·æ›´æ–°ï¼Œæ”¯æŒä»·æ ¼ä¸æ—¶é—´åŒæé†’ï¼Œæ™ºèƒ½äº¤æ˜“è®¡åˆ’ç®¡ç†</p>
        </header>
        
        <div class="app-controls">
            <div class="btn-row">
                <button class="btn-primary" id="addPlanBtn">
                    <i class="fas fa-plus-circle"></i> åˆ›å»ºæ–°è®¡åˆ’
                </button>
                <button class="btn-success" id="updatePricesBtn">
                    <i class="fas fa-cloud-download-alt"></i> æ›´æ–°è‚¡ä»·
                </button>
            </div>
        </div>
        
        <div class="update-info" id="updateInfo" style="display: none;">
            <div>æœ€åæ›´æ–°: <span id="lastUpdateTime">--</span></div>
            <div>æ•°æ®æº: <span id="dataSource">æœªè·å–</span> | çŠ¶æ€: <span id="updateStatus">--</span></div>
            <div>ä¸‹æ¬¡æ›´æ–°: <span id="nextUpdateTime">--</span></div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-filter="interested">å…³æ³¨ (<span id="interestedCount">0</span>)</div>
            <div class="tab" data-filter="in-progress">è¿›è¡Œä¸­ (<span id="inProgressCount">0</span>)</div>
            <div class="tab" data-filter="completed">å·²ç»“æŸ (<span id="completedCount">0</span>)</div>
        </div>
        
        <div class="plans-container" id="plansContainer">
            <!-- äº¤æ˜“è®¡åˆ’å¡ç‰‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div id="emptyState" class="empty-state" style="display: none;">
            <i class="fas fa-clipboard-list"></i>
            <h3>æš‚æ— äº¤æ˜“è®¡åˆ’</h3>
            <p>ç‚¹å‡»ä¸Šæ–¹çš„"åˆ›å»ºæ–°è®¡åˆ’"æŒ‰é’®å¼€å§‹æ·»åŠ </p>
        </div>
        
        <footer>
            <p>äº¤æ˜“è®¡åˆ’æé†’å·¥å…· &copy; 2023</p>
            <p style="font-size: 11px;">è‚¡ç¥¨ä»·æ ¼æ•°æ®æ¥æº: æ–°æµªè´¢ç»API</p>
            <p style="font-size: 11px; color: #666;">
                äº‘å‡½æ•°çŠ¶æ€: <span id="cloudFunctionStatus" style="color: #4caf50; font-weight: 600;">å¾…æµ‹è¯•</span>
            </p>
        </footer>
    </div>
    
    <!-- æ·»åŠ /ç¼–è¾‘äº¤æ˜“è®¡åˆ’æ¨¡æ€æ¡† -->
    <div class="modal" id="planModal">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader">
                åˆ›å»ºæ–°äº¤æ˜“è®¡åˆ’
            </div>
            <div class="modal-body">
                <form id="planForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="stockName">è‚¡ç¥¨åç§° *</label>
                            <input type="text" id="stockName" required placeholder="ä¾‹å¦‚: è´µå·èŒ…å°">
                        </div>
                        <div class="form-group">
                            <label for="stockCode">è‚¡ç¥¨ä»£ç  *</label>
                            <input type="text" id="stockCode" required placeholder="ä¾‹å¦‚: 600519">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="currentPrice">å½“å‰ä»·æ ¼ *</label>
                        <input type="number" step="0.01" id="currentPrice" required placeholder="ä¾‹å¦‚: 1650.80">
                        <small style="color: #666; font-size: 11px;">åˆ›å»ºåéœ€è¦é€šè¿‡"æ›´æ–°è‚¡ä»·"è·å–å®æ—¶ä»·æ ¼</small>
                    </div>
                    
                    <div class="form-group">
                        <label>äº¤æ˜“è®¡åˆ’</label>
                        <div id="signalsContainer">
                            <!-- è®¡åˆ’è¾“å…¥åŒºåŸŸå°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        <button type="button" class="btn-add-signal" id="addSignalBtn" style="margin-top: 10px; padding: 8px 12px; background: #4caf50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                            <i class="fas fa-plus"></i> æ·»åŠ è®¡åˆ’
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">å¤‡æ³¨</label>
                        <textarea id="notes" rows="2" placeholder="å¯æ·»åŠ äº¤æ˜“æ€è·¯ã€æ­¢æŸæ­¢ç›ˆä½ç­‰å¤‡æ³¨ä¿¡æ¯..."></textarea>
                    </div>
                    
                    <input type="hidden" id="planId">
                </form>
            </div>
            <div class="modal-footer" style="padding: 15px; background-color: #f9fafc; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #eee;">
                <button class="btn-secondary" id="cancelBtn" style="padding: 8px 16px; background: transparent; border: 1px solid #1a6dff; color: #1a6dff; border-radius: 6px; cursor: pointer;">å–æ¶ˆ</button>
                <button class="btn-primary" id="savePlanBtn" style="padding: 8px 16px; background: #1a6dff; color: white; border: none; border-radius: 6px; cursor: pointer;">ä¿å­˜è®¡åˆ’</button>
            </div>
        </div>
    </div>

    <!-- äº¤æ˜“è®°å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="historyModal">
        <div class="modal-content history-modal">
            <div class="modal-header" id="historyModalHeader">
                äº¤æ˜“è®°å½•
            </div>
            <div class="modal-body" id="historyModalBody">
                <!-- äº¤æ˜“è®°å½•å†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="modal-footer" style="padding: 15px; background-color: #f9fafc; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #eee;">
                <button class="btn-secondary" id="closeHistoryBtn" style="padding: 8px 16px; background: transparent; border: 1px solid #1a6dff; color: #1a6dff; border-radius: 6px; cursor: pointer;">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        // ================ é…ç½®éƒ¨åˆ† ================
        // è¯·æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„äº‘å‡½æ•°URL
        const CLOUD_FUNCTION_URL = 'https://1400356775-kmdwvqalgd.ap-guangzhou.tencentscf.com';
        
        // è‡ªåŠ¨æ›´æ–°æ—¶é—´ç‚¹
        const AUTO_UPDATE_TIMES = [
            { hour: 9, minute: 30 },
            { hour: 12, minute: 0 },
            { hour: 15, minute: 0 }
        ];

        // ================ æ ¸å¿ƒæ•°æ®ä¸å‡½æ•° ================
        let tradingPlans = [];
        let lastUpdateTimestamp = null;
        let nextAutoUpdate = null;
        let autoUpdateTimer = null;
        let currentFilter = 'interested';
        let isEditing = false;
        let currentEditId = null;
        let currentHistoryId = null;
        let signalCount = 0;
        let cloudFunctionStatus = 'æœªæµ‹è¯•';

        // DOMå…ƒç´ å¼•ç”¨
        const plansContainer = document.getElementById('plansContainer');
        const emptyState = document.getElementById('emptyState');
        const planModal = document.getElementById('planModal');
        const historyModal = document.getElementById('historyModal');
        const planForm = document.getElementById('planForm');
        const modalHeader = document.getElementById('modalHeader');
        const historyModalHeader = document.getElementById('historyModalHeader');
        const historyModalBody = document.getElementById('historyModalBody');
        const signalsContainer = document.getElementById('signalsContainer');
        const tabs = document.querySelectorAll('.tab');
        const updateInfo = document.getElementById('updateInfo');
        const lastUpdateTime = document.getElementById('lastUpdateTime');
        const updateStatus = document.getElementById('updateStatus');
        const updatePricesBtn = document.getElementById('updatePricesBtn');
        const nextUpdateTime = document.getElementById('nextUpdateTime');
        const dataSource = document.getElementById('dataSource');
        const interestedCount = document.getElementById('interestedCount');
        const inProgressCount = document.getElementById('inProgressCount');
        const completedCount = document.getElementById('completedCount');
        const cloudFunctionStatusSpan = document.getElementById('cloudFunctionStatus');

        // ================ åˆå§‹åŒ–å‡½æ•° ================
        function initSampleData() {
            const samplePlans = [
                {
                    id: 1,
                    stockName: "ä¸‡ç§‘A",
                    stockCode: "000002",
                    currentPrice: 0,
                    priceAvailable: false,
                    status: "interested",
                    signals: [
                        { type: "time", target: new Date(Date.now() + 86400000).toISOString().slice(0, 16), description: "æé†’æ£€æŸ¥", triggered: false },
                        { type: "price", target: 5.50, condition: ">", description: "ç›®æ ‡ä»·ä½", triggered: false }
                    ],
                    notes: "è§‚å¯Ÿçªç ´æƒ…å†µ",
                    createdAt: new Date(),
                    lastUpdated: new Date(),
                    dataSource: "initial",
                    history: [
                        {
                            status: "interested",
                            time: new Date(),
                            price: 0,
                            priceAvailable: false,
                            action: "åˆ›å»ºè®¡åˆ’",
                            signals: []
                        }
                    ]
                }
            ];
            
            if (!localStorage.getItem('tradingPlans')) {
                tradingPlans = samplePlans;
                savePlansToStorage();
            }
        }

        function loadPlansFromStorage() {
            const savedPlans = localStorage.getItem('tradingPlans');
            if (savedPlans) {
                try {
                    tradingPlans = JSON.parse(savedPlans);
                    tradingPlans.forEach(plan => {
                        plan.createdAt = new Date(plan.createdAt);
                        plan.lastUpdated = plan.lastUpdated ? new Date(plan.lastUpdated) : new Date();
                        plan.priceAvailable = plan.priceAvailable !== undefined ? plan.priceAvailable : false;
                        
                        if (!plan.history) {
                            plan.history = [
                                {
                                    status: plan.status,
                                    time: plan.createdAt,
                                    price: plan.currentPrice,
                                    priceAvailable: plan.priceAvailable,
                                    action: "åˆ›å»ºè®¡åˆ’",
                                    signals: []
                                }
                            ];
                        } else {
                            plan.history.forEach(item => {
                                item.time = new Date(item.time);
                                item.priceAvailable = item.priceAvailable !== undefined ? item.priceAvailable : false;
                            });
                        }
                    });
                } catch (e) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', e);
                    initSampleData();
                }
            } else {
                initSampleData();
            }
        }

        function savePlansToStorage() {
            localStorage.setItem('tradingPlans', JSON.stringify(tradingPlans));
            updatePlanCounts();
        }

        function updatePlanCounts() {
            const interested = tradingPlans.filter(p => p.status === 'interested').length;
            const inProgress = tradingPlans.filter(p => p.status === 'in-progress').length;
            const completed = tradingPlans.filter(p => p.status === 'completed').length;
            
            interestedCount.textContent = interested;
            inProgressCount.textContent = inProgress;
            completedCount.textContent = completed;
        }

        // ================ å·¥å…·å‡½æ•° ================
        function getActiveStockCodes() {
            const activeCodes = [];
            tradingPlans.forEach(plan => {
                if (plan.status === 'interested' || plan.status === 'in-progress') {
                    const code = plan.stockCode.toString().padStart(6, '0');
                    if (!activeCodes.includes(code)) {
                        activeCodes.push(code);
                    }
                }
            });
            return activeCodes;
        }

        function formatTime(date) {
            if (!date) return "ä»æœª";
            const now = new Date();
            const diffMs = now - new Date(date);
            const diffMins = Math.floor(diffMs / (1000 * 60));
            
            if (diffMins < 1) return "åˆšåˆš";
            if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`;
            
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
            
            const diffDays = Math.floor(diffHours / 24);
            if (diffDays < 30) return `${diffDays}å¤©å‰`;
            
            const diffMonths = Math.floor(diffDays / 30);
            return `${diffMonths}æœˆå‰`;
        }

        function formatDateTime(date) {
            if (!date) return "";
            const d = new Date(date);
            return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
        }

        function showNotification(message, isError = false, isWarning = false) {
            const notification = document.createElement('div');
            notification.className = `notification ${isError ? 'error' : isWarning ? 'warning' : ''}`;
            notification.innerHTML = `<i class="fas fa-${isError ? 'exclamation-circle' : isWarning ? 'exclamation-triangle' : 'check-circle'}"></i> ${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // ================ è‚¡ä»·æ›´æ–°æ ¸å¿ƒåŠŸèƒ½ ================
        async function updateRealStockPrices() {
            const activeCodes = getActiveStockCodes();
            
            if (activeCodes.length === 0) {
                showNotification('æ²¡æœ‰éœ€è¦æ›´æ–°çš„è‚¡ç¥¨', true);
                return 0;
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const originalText = updatePricesBtn.innerHTML;
            updatePricesBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ›´æ–°ä¸­...';
            updatePricesBtn.disabled = true;
            updateStatus.textContent = 'æ›´æ–°ä¸­...';
            dataSource.textContent = 'è¯·æ±‚ä¸­...';
            
            try {
                console.log('å¼€å§‹æ›´æ–°è‚¡ä»·ï¼Œè‚¡ç¥¨ä»£ç :', activeCodes);
                console.log('è°ƒç”¨äº‘å‡½æ•°URL:', CLOUD_FUNCTION_URL);
                
                // å°è¯•ä½¿ç”¨ä¸»äº‘å‡½æ•°
                let result;
                let response;
                try {
                    response = await fetch(CLOUD_FUNCTION_URL, {
                        method: 'POST',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            codes: activeCodes,
                            timestamp: Date.now()
                        })
                    });
                    
                    console.log('å“åº”çŠ¶æ€ç :', response.status);
                    console.log('å“åº”çŠ¶æ€:', response.statusText);
                    
                    if (!response.ok) {
                        throw new Error(`äº‘å‡½æ•°è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                    }
                    
                    // æ£€æŸ¥å“åº”ç±»å‹
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await response.text();
                        console.error('éJSONå“åº”:', text.substring(0, 200));
                        throw new Error(`æœåŠ¡å™¨è¿”å›éJSONæ ¼å¼: ${contentType}`);
                    }
                    
                    result = await response.json();
                    console.log('äº‘å‡½æ•°è¿”å›ç»“æœ:', result);
                    
                    if (result.success) {
                        dataSource.textContent = 'æ–°æµªå®æ—¶';
                        cloudFunctionStatus = 'æ­£å¸¸';
                        cloudFunctionStatusSpan.textContent = cloudFunctionStatus;
                        cloudFunctionStatusSpan.style.color = '#4caf50';
                    } else {
                        dataSource.textContent = 'è·å–å¤±è´¥';
                        cloudFunctionStatus = 'APIå¤±è´¥';
                        cloudFunctionStatusSpan.textContent = cloudFunctionStatus;
                        cloudFunctionStatusSpan.style.color = '#ff9800';
                    }
                    
                } catch (cloudError) {
                    console.warn('äº‘å‡½æ•°è¿æ¥å¤±è´¥:', cloudError.message);
                    
                    // å¦‚æœäº‘å‡½æ•°URLé”™è¯¯ï¼Œæ£€æŸ¥URLæ˜¯å¦æ­£ç¡®
                    if (cloudError.message.includes('Failed to fetch')) {
                        console.error('æ— æ³•è¿æ¥åˆ°äº‘å‡½æ•°ï¼Œè¯·æ£€æŸ¥URL:', CLOUD_FUNCTION_URL);
                        showNotification('æ— æ³•è¿æ¥åˆ°äº‘å‡½æ•°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–URLé…ç½®', true);
                        cloudFunctionStatus = 'è¿æ¥å¤±è´¥';
                        cloudFunctionStatusSpan.textContent = cloudFunctionStatus;
                        cloudFunctionStatusSpan.style.color = '#f44336';
                    }
                    
                    dataSource.textContent = 'è¿æ¥å¤±è´¥';
                    
                    // è¿”å›ç©ºç»“æœ
                    result = {
                        success: false,
                        message: 'äº‘å‡½æ•°è¿æ¥å¤±è´¥',
                        data: []
                    };
                }
                
                // æ›´æ–°æ•°æ®
                let updatedCount = 0;
                let realDataCount = 0;
                
                if (result.success && result.data && Array.isArray(result.data)) {
                    // å¤„ç†çœŸå®æ•°æ®
                    result.data.forEach(stock => {
                        tradingPlans.forEach(plan => {
                            const planCode = plan.stockCode.toString().padStart(6, '0');
                            const stockCode = stock.code.toString().padStart(6, '0');
                            
                            if (planCode === stockCode && 
                                (plan.status === 'interested' || plan.status === 'in-progress')) {
                                const oldPrice = plan.currentPrice;
                                const oldPriceAvailable = plan.priceAvailable;
                                
                                plan.currentPrice = stock.price || stock.currentPrice;
                                plan.priceAvailable = true;
                                plan.lastUpdated = new Date();
                                plan.dataSource = 'realtime';
                                updatedCount++;
                                realDataCount++;
                                
                                // åªæœ‰åœ¨ä»·æ ¼æœ‰æ•ˆæ—¶æ‰æ£€æŸ¥ä¿¡å·
                                if (oldPriceAvailable) {
                                    checkPriceSignals(plan, oldPrice, plan.currentPrice);
                                }
                            }
                        });
                    });
                    
                    // æ ‡è®°æœªè·å–åˆ°æ•°æ®çš„è‚¡ç¥¨
                    tradingPlans.forEach(plan => {
                        if ((plan.status === 'interested' || plan.status === 'in-progress') && 
                            plan.dataSource !== 'realtime') {
                            plan.priceAvailable = false;
                            plan.dataSource = 'unavailable';
                            plan.lastUpdated = new Date();
                        }
                    });
                } else {
                    // äº‘å‡½æ•°å¤±è´¥ï¼Œæ ‡è®°æ‰€æœ‰è‚¡ç¥¨ä¸ºæœªè·å–
                    tradingPlans.forEach(plan => {
                        if (plan.status === 'interested' || plan.status === 'in-progress') {
                            plan.priceAvailable = false;
                            plan.dataSource = 'unavailable';
                            plan.lastUpdated = new Date();
                        }
                    });
                }
                
                // æ£€æŸ¥æ—¶é—´ä¿¡å·
                checkTimeSignals();
                
                // ä¿å­˜å¹¶æ›´æ–°UI
                lastUpdateTimestamp = new Date();
                savePlansToStorage();
                renderPlans();
                updateLastUpdateTime();
                
                if (realDataCount > 0) {
                    updateStatus.textContent = `å·²æ›´æ–° ${realDataCount} åªè‚¡ç¥¨`;
                    showNotification(`æˆåŠŸè·å– ${realDataCount} åªè‚¡ç¥¨å®æ—¶ä»·æ ¼`, false);
                } else if (result.success) {
                    updateStatus.textContent = 'æœªè·å–åˆ°æ•°æ®';
                    showNotification('æœªè·å–åˆ°è‚¡ç¥¨å®æ—¶æ•°æ®ï¼Œè¯·ç¨åé‡è¯•', true);
                } else {
                    updateStatus.textContent = 'è·å–å¤±è´¥';
                    showNotification('è‚¡ç¥¨æ•°æ®è·å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', true);
                }
                
                return realDataCount;
                
            } catch (error) {
                console.error('æ›´æ–°è‚¡ä»·å¤±è´¥:', error);
                updateStatus.textContent = 'æ›´æ–°å¤±è´¥';
                dataSource.textContent = 'æ›´æ–°å¤±è´¥';
                cloudFunctionStatus = 'æ›´æ–°å¤±è´¥';
                cloudFunctionStatusSpan.textContent = cloudFunctionStatus;
                cloudFunctionStatusSpan.style.color = '#f44336';
                
                // æ ‡è®°æ‰€æœ‰è‚¡ç¥¨ä¸ºæœªè·å–
                tradingPlans.forEach(plan => {
                    if (plan.status === 'interested' || plan.status === 'in-progress') {
                        plan.priceAvailable = false;
                        plan.dataSource = 'unavailable';
                        plan.lastUpdated = new Date();
                    }
                });
                
                savePlansToStorage();
                renderPlans();
                updateLastUpdateTime();
                
                showNotification('è‚¡ä»·æ›´æ–°å¤±è´¥', true);
                
                return 0;
            } finally {
                updatePricesBtn.innerHTML = originalText;
                updatePricesBtn.disabled = false;
            }
        }

        // ================ ä¿¡å·æ£€æŸ¥åŠŸèƒ½ ================
        function checkPriceSignals(plan, oldPrice, newPrice) {
            const triggeredSignals = [];
            
            plan.signals.forEach(signal => {
                if (signal.type === 'price' && !signal.triggered) {
                    const target = parseFloat(signal.target);
                    const condition = signal.condition;
                    
                    let shouldTrigger = false;
                    
                    if (condition === '>') {
                        shouldTrigger = oldPrice <= target && newPrice > target;
                    } else if (condition === '<') {
                        shouldTrigger = oldPrice >= target && newPrice < target;
                    } else if (condition === '>=') {
                        shouldTrigger = oldPrice < target && newPrice >= target;
                    } else if (condition === '<=') {
                        shouldTrigger = oldPrice > target && newPrice <= target;
                    }
                    
                    if (shouldTrigger) {
                        signal.triggered = true;
                        triggeredSignals.push(`${signal.description} (${condition}${target})`);
                        showNotification(`ğŸš¨ ${plan.stockName}(${plan.stockCode}) è§¦å‘ä»·æ ¼æé†’ï¼š${signal.description}`, false, true);
                    }
                }
            });
            
            // è®°å½•è§¦å‘å†å²
            if (triggeredSignals.length > 0) {
                if (!plan.history) plan.history = [];
                plan.history.push({
                    status: plan.status,
                    time: new Date(),
                    price: newPrice,
                    priceAvailable: true,
                    action: "ä»·æ ¼æé†’è§¦å‘",
                    signals: triggeredSignals
                });
            }
        }

        function checkTimeSignals() {
            const now = new Date();
            
            tradingPlans.forEach(plan => {
                const triggeredSignals = [];
                
                plan.signals.forEach(signal => {
                    if (signal.type === 'time' && !signal.triggered) {
                        const targetTime = new Date(signal.target);
                        const diffMs = now - targetTime;
                        const diffHours = diffMs / (1000 * 60 * 60);
                        
                        // åœ¨å½“å‰æ—¶é—´ä¹‹å1å°æ—¶å†…è§¦å‘
                        if (diffMs >= 0 && diffHours <= 1) {
                            signal.triggered = true;
                            triggeredSignals.push(`${signal.description} (${formatDateTime(targetTime)})`);
                            showNotification(`â° ${plan.stockName}(${plan.stockCode}) æ—¶é—´æé†’ï¼š${signal.description}`, false, true);
                        }
                    }
                });
                
                // è®°å½•è§¦å‘å†å²
                if (triggeredSignals.length > 0) {
                    if (!plan.history) plan.history = [];
                    plan.history.push({
                        status: plan.status,
                        time: new Date(),
                        price: plan.currentPrice,
                        priceAvailable: plan.priceAvailable,
                        action: "æ—¶é—´æé†’è§¦å‘",
                        signals: triggeredSignals
                    });
                }
            });
        }

        // ================ è‡ªåŠ¨æ›´æ–°åŠŸèƒ½ ================
        function updateLastUpdateTime() {
            if (lastUpdateTimestamp) {
                lastUpdateTime.textContent = `${formatTime(lastUpdateTimestamp)}`;
            }
            
            if (tradingPlans.length > 0) {
                updateInfo.style.display = 'flex';
            }
            
            // æ›´æ–°ä¸‹æ¬¡è‡ªåŠ¨æ›´æ–°æ—¶é—´
            if (nextAutoUpdate) {
                const now = new Date();
                const diffMs = nextAutoUpdate - now;
                const diffMins = Math.floor(diffMs / (1000 * 60));
                
                if (diffMins > 0) {
                    nextUpdateTime.textContent = `${diffMins}åˆ†é’Ÿå`;
                } else {
                    nextUpdateTime.textContent = 'å³å°†æ›´æ–°';
                }
            }
        }

        function calculateNextAutoUpdate() {
            const now = new Date();
            let nextUpdate = null;
            
            for (const time of AUTO_UPDATE_TIMES) {
                const updateTime = new Date();
                updateTime.setHours(time.hour, time.minute, 0, 0);
                
                if (updateTime > now) {
                    nextUpdate = updateTime;
                    break;
                }
            }
            
            if (!nextUpdate) {
                const firstTime = AUTO_UPDATE_TIMES[0];
                nextUpdate = new Date();
                nextUpdate.setDate(nextUpdate.getDate() + 1);
                nextUpdate.setHours(firstTime.hour, firstTime.minute, 0, 0);
            }
            
            return nextUpdate;
        }

        function setupAutoUpdateTimer() {
            if (autoUpdateTimer) {
                clearTimeout(autoUpdateTimer);
            }
            
            nextAutoUpdate = calculateNextAutoUpdate();
            
            const now = new Date();
            const msUntilNextUpdate = nextAutoUpdate - now;
            
            autoUpdateTimer = setTimeout(async () => {
                showNotification('è‡ªåŠ¨æ›´æ–°ï¼šæ­£åœ¨è·å–æœ€æ–°è‚¡ä»·...', false);
                try {
                    await updateRealStockPrices();
                    showNotification('è‡ªåŠ¨æ›´æ–°ï¼šè‚¡ä»·å·²æ›´æ–°å®Œæˆï¼', false);
                } catch (error) {
                    console.error('è‡ªåŠ¨æ›´æ–°å¤±è´¥:', error);
                }
                setupAutoUpdateTimer();
            }, msUntilNextUpdate);
            
            console.log(`ä¸‹ä¸€æ¬¡è‡ªåŠ¨æ›´æ–°: ${nextAutoUpdate.toLocaleTimeString()}`);
        }

        // ================ æ¸²æŸ“åŠŸèƒ½ ================
        function renderPlans() {
            plansContainer.innerHTML = '';
            
            updateLastUpdateTime();
            updatePlanCounts();
            
            let filteredPlans = tradingPlans.filter(plan => plan.status === currentFilter);
            filteredPlans.sort((a, b) => b.lastUpdated - a.lastUpdated);
            
            if (filteredPlans.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            filteredPlans.forEach(plan => {
                const planCard = document.createElement('div');
                planCard.className = 'plan-card';
                
                // çŠ¶æ€æ ‡ç­¾
                let statusText = '';
                let statusClass = '';
                switch(plan.status) {
                    case 'interested':
                        statusText = 'å…³æ³¨';
                        statusClass = 'status-interested';
                        break;
                    case 'in-progress':
                        statusText = 'è¿›è¡Œä¸­';
                        statusClass = 'status-in-progress';
                        break;
                    case 'completed':
                        statusText = 'å·²ç»“æŸ';
                        statusClass = 'status-completed';
                        break;
                }
                
                // æ•°æ®æ¥æºæ ‡è®°
                let dataSourceText = '';
                let dataSourceClass = '';
                switch(plan.dataSource) {
                    case 'realtime':
                        dataSourceText = 'å®æ—¶';
                        dataSourceClass = 'data-source-realtime';
                        break;
                    case 'unavailable':
                        dataSourceText = 'æœªè·å–';
                        dataSourceClass = 'data-source-unavailable';
                        break;
                    case 'initial':
                    default:
                        dataSourceText = 'åˆå§‹';
                        dataSourceClass = 'data-source-initial';
                        break;
                }
                
                const dataSourceBadge = `<span class="data-source-badge ${dataSourceClass}">${dataSourceText}</span>`;
                
                // ä»·æ ¼æ˜¾ç¤º
                let priceHTML = '';
                if (plan.priceAvailable && plan.currentPrice > 0) {
                    priceHTML = `
                        <div class="current-price">Â¥${plan.currentPrice.toFixed(2)}</div>
                        <div class="price-update-time">${formatTime(plan.lastUpdated)}</div>
                    `;
                } else {
                    priceHTML = `
                        <div class="current-price unavailable">æœªè·å–</div>
                        <div class="price-update-time">${formatTime(plan.lastUpdated)}</div>
                    `;
                }
                
                // è®¡åˆ’åˆ—è¡¨HTML
                let signalsHTML = '';
                plan.signals.forEach((signal, index) => {
                    const signalTypeText = signal.type === 'time' ? 'æ—¶é—´' : 'ä»·æ ¼';
                    const signalTagClass = signal.type === 'time' ? 'time' : 'price';
                    const triggeredClass = signal.triggered ? 'style="text-decoration: line-through; color: #888;"' : '';
                    
                    let targetDisplay = '';
                    if (signal.type === 'time') {
                        targetDisplay = formatDateTime(new Date(signal.target));
                    } else {
                        targetDisplay = `${signal.condition} ${signal.target}`;
                    }
                    
                    signalsHTML += `
                        <div class="signal-item">
                            <div class="signal-type">${signalTypeText}</div>
                            <div class="signal-desc" ${triggeredClass}>${signal.description}</div>
                            <div class="signal-target">${targetDisplay}</div>
                            <div class="signal-tag ${signalTagClass}">${signal.triggered ? 'å·²è§¦å‘' : 'æœªè§¦å‘'}</div>
                        </div>
                    `;
                });
                
                planCard.innerHTML = `
                    <div class="plan-header">
                        <div class="stock-info">
                            <div class="stock-name">${plan.stockName} ${dataSourceBadge}</div>
                            <div class="stock-code">${plan.stockCode}</div>
                            <span class="plan-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="price-info">
                            ${priceHTML}
                        </div>
                    </div>
                    <div class="plan-content">
                        <div class="signals-list">
                            ${signalsHTML}
                        </div>
                        ${plan.notes ? `<div style="margin-top: 12px; padding: 10px; background: #f9f9f9; border-radius: 6px; font-size: 12px;"><strong>å¤‡æ³¨:</strong> ${plan.notes}</div>` : ''}
                    </div>
                    <div class="plan-actions">
                `;
                
                // æ ¹æ®ä¸åŒçŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æ“ä½œæŒ‰é’®
                if (plan.status === 'interested') {
                    planCard.innerHTML += `
                        <button class="btn-secondary edit-btn" data-id="${plan.id}">
                            <i class="fas fa-edit"></i> ç¼–è¾‘
                        </button>
                        <button class="btn-execute execute-btn" data-id="${plan.id}">
                            <i class="fas fa-play-circle"></i> æ‰§è¡Œ
                        </button>
                        <button class="btn-sell delete-btn" data-id="${plan.id}">
                            <i class="fas fa-trash"></i> åˆ é™¤
                        </button>
                    `;
                } else if (plan.status === 'in-progress') {
                    planCard.innerHTML += `
                        <button class="btn-secondary edit-btn" data-id="${plan.id}">
                            <i class="fas fa-edit"></i> ç¼–è¾‘
                        </button>
                        <button class="btn-sell sell-btn" data-id="${plan.id}">
                            <i class="fas fa-money-bill-wave"></i> å–å‡º
                        </button>
                        <button class="btn-history history-btn" data-id="${plan.id}">
                            <i class="fas fa-history"></i> è®°å½•
                        </button>
                    `;
                } else if (plan.status === 'completed') {
                    planCard.innerHTML += `
                        <button class="btn-history history-btn" data-id="${plan.id}">
                            <i class="fas fa-history"></i> äº¤æ˜“è®°å½•
                        </button>
                        <button class="btn-sell delete-btn" data-id="${plan.id}">
                            <i class="fas fa-trash"></i> åˆ é™¤
                        </button>
                    `;
                }
                
                planCard.innerHTML += `</div>`;
                plansContainer.appendChild(planCard);
            });
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            attachEventListeners();
        }

        function attachEventListeners() {
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const planId = parseInt(e.currentTarget.getAttribute('data-id'));
                    openEditModal(planId);
                });
            });
            
            document.querySelectorAll('.execute-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const planId = parseInt(e.currentTarget.getAttribute('data-id'));
                    executePlan(planId);
                });
            });
            
            document.querySelectorAll('.sell-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const planId = parseInt(e.currentTarget.getAttribute('data-id'));
                    if (e.currentTarget.textContent.includes('å–å‡º')) {
                        sellPlan(planId);
                    } else {
                        deletePlan(planId);
                    }
                });
            });
            
            document.querySelectorAll('.history-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const planId = parseInt(e.currentTarget.getAttribute('data-id'));
                    showHistoryModal(planId);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const planId = parseInt(e.currentTarget.getAttribute('data-id'));
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäº¤æ˜“è®¡åˆ’å—ï¼Ÿ')) {
                        deletePlan(planId);
                    }
                });
            });
        }

        // ================ è®¡åˆ’æ“ä½œå‡½æ•° ================
        function executePlan(planId) {
            const plan = tradingPlans.find(p => p.id === planId);
            if (!plan) return;
            
            plan.status = 'in-progress';
            plan.lastUpdated = new Date();
            
            if (!plan.history) plan.history = [];
            plan.history.push({
                status: 'in-progress',
                time: new Date(),
                price: plan.currentPrice,
                priceAvailable: plan.priceAvailable,
                action: "å¼€å§‹æ‰§è¡Œ",
                signals: []
            });
            
            savePlansToStorage();
            renderPlans();
            showNotification(`å·²å°† ${plan.stockName} å¼€å§‹æ‰§è¡Œ`);
        }

        function sellPlan(planId) {
            const plan = tradingPlans.find(p => p.id === planId);
            if (!plan) return;
            
            plan.status = 'completed';
            plan.lastUpdated = new Date();
            
            if (!plan.history) plan.history = [];
            plan.history.push({
                status: 'completed',
                time: new Date(),
                price: plan.currentPrice,
                priceAvailable: plan.priceAvailable,
                action: "å–å‡ºç»“æŸ",
                signals: []
            });
            
            savePlansToStorage();
            renderPlans();
            showNotification(`å·²å°† ${plan.stockName} å–å‡ºç»“æŸ`);
        }

        function deletePlan(planId) {
            const planIndex = tradingPlans.findIndex(p => p.id === planId);
            if (planIndex !== -1) {
                const planName = tradingPlans[planIndex].stockName;
                tradingPlans.splice(planIndex, 1);
                savePlansToStorage();
                renderPlans();
                showNotification(`å·²åˆ é™¤ ${planName} çš„äº¤æ˜“è®¡åˆ’`);
            }
        }

        function showHistoryModal(planId) {
            const plan = tradingPlans.find(p => p.id === planId);
            if (!plan) return;
            
            currentHistoryId = planId;
            historyModalHeader.textContent = `${plan.stockName}(${plan.stockCode}) äº¤æ˜“è®°å½•`;
            
            let historyHTML = '';
            
            if (plan.history && plan.history.length > 0) {
                const sortedHistory = [...plan.history].sort((a, b) => a.time - b.time);
                
                sortedHistory.forEach((record, index) => {
                    let statusText = '';
                    let statusClass = '';
                    switch(record.status) {
                        case 'interested':
                            statusText = 'å…³æ³¨';
                            statusClass = 'interested';
                            break;
                        case 'in-progress':
                            statusText = 'è¿›è¡Œä¸­';
                            statusClass = 'in-progress';
                            break;
                        case 'completed':
                            statusText = 'å·²ç»“æŸ';
                            statusClass = 'completed';
                            break;
                    }
                    
                    const priceDisplay = record.priceAvailable ? `Â¥${record.price.toFixed(2)}` : 'æœªè·å–';
                    
                    historyHTML += `
                        <div class="timeline-item ${statusClass}">
                            <div class="timeline-header">
                                <div class="timeline-status ${statusClass}">${statusText}</div>
                                <div class="timeline-time">${formatDateTime(record.time)}</div>
                            </div>
                            <div class="timeline-price">ä»·æ ¼: ${priceDisplay}</div>
                            <div style="margin: 5px 0; font-weight: 600;">${record.action}</div>
                            ${record.signals && record.signals.length > 0 ? `
                                <div class="timeline-signals">
                                    ${record.signals.map(signal => `
                                        <div class="timeline-signal triggered"><i class="fas fa-bell"></i> ${signal}</div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            } else {
                historyHTML = '<p style="text-align: center; color: #888;">æš‚æ— äº¤æ˜“è®°å½•</p>';
            }
            
            historyModalBody.innerHTML = `
                <div class="history-timeline">
                    ${historyHTML}
                </div>
            `;
            
            historyModal.style.display = 'flex';
        }

        // ================ æ¨¡æ€æ¡†ç›¸å…³å‡½æ•° ================
        function openAddModal() {
            isEditing = false;
            currentEditId = null;
            modalHeader.textContent = 'åˆ›å»ºæ–°äº¤æ˜“è®¡åˆ’';
            planForm.reset();
            signalsContainer.innerHTML = '';
            signalCount = 0;
            addSignalInput();
            
            // è®¾ç½®é»˜è®¤æ—¶é—´ä¸ºæ˜å¤©
            const tomorrow = new Date(Date.now() + 86400000);
            document.querySelector('.signal-target[type="datetime-local"]').value = 
                tomorrow.toISOString().slice(0, 16);
            
            planModal.style.display = 'flex';
            setTimeout(() => {
                document.getElementById('stockName').focus();
            }, 100);
        }

        function openEditModal(planId) {
            isEditing = true;
            currentEditId = planId;
            modalHeader.textContent = 'ç¼–è¾‘äº¤æ˜“è®¡åˆ’';
            
            const plan = tradingPlans.find(p => p.id === planId);
            if (!plan) return;
            
            document.getElementById('stockName').value = plan.stockName;
            document.getElementById('stockCode').value = plan.stockCode;
            document.getElementById('currentPrice').value = plan.priceAvailable ? plan.currentPrice : '';
            document.getElementById('notes').value = plan.notes;
            document.getElementById('planId').value = planId;
            
            signalsContainer.innerHTML = '';
            signalCount = 0;
            
            plan.signals.forEach(signal => {
                let targetValue = signal.target;
                if (signal.type === 'time' && typeof targetValue === 'string') {
                    targetValue = new Date(targetValue).toISOString().slice(0, 16);
                }
                addSignalInput(signal.type, targetValue, signal.condition, signal.description, signal.triggered);
            });
            
            planModal.style.display = 'flex';
        }

        function addSignalInput(type = 'time', target = '', condition = '>', description = '', triggered = false) {
            signalCount++;
            const signalDiv = document.createElement('div');
            signalDiv.className = 'signal-inputs';
            signalDiv.style.border = '1px solid #eee'; 
            signalDiv.style.borderRadius = '8px'; 
            signalDiv.style.padding = '12px'; 
            signalDiv.style.marginBottom = '12px';
            
            let typeSpecificFields = '';
            
            if (type === 'time') {
                typeSpecificFields = `
                    <div class="form-group">
                        <label style="font-size: 12px;">æé†’æ—¶é—´</label>
                        <input type="datetime-local" class="signal-target" value="${target}" required style="font-size: 14px; padding: 8px 10px;">
                    </div>
                `;
            } else {
                typeSpecificFields = `
                    <div class="form-row">
                        <div class="form-group">
                            <label style="font-size: 12px;">æ¡ä»¶</label>
                            <select class="signal-condition" required style="font-size: 14px; padding: 8px 10px;">
                                <option value=">" ${condition === '>' ? 'selected' : ''}>å¤§äº</option>
                                <option value="<" ${condition === '<' ? 'selected' : ''}>å°äº</option>
                                <option value=">=" ${condition === '>=' ? 'selected' : ''}>å¤§äºç­‰äº</option>
                                <option value="<=" ${condition === '<=' ? 'selected' : ''}>å°äºç­‰äº</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label style="font-size: 12px;">ç›®æ ‡ä»·æ ¼</label>
                            <input type="number" step="0.01" class="signal-target" value="${target}" required style="font-size: 14px; padding: 8px 10px;">
                        </div>
                    </div>
                `;
            }
            
            signalDiv.innerHTML = `
                <div class="signal-inputs-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h4 style="margin: 0; font-size: 14px;">è®¡åˆ’ #${signalCount}</h4>
                    <button type="button" class="remove-signal-btn" style="padding: 4px 8px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        <i class="fas fa-trash"></i> åˆ é™¤
                    </button>
                </div>
                <div class="form-group">
                    <label style="font-size: 12px;">è®¡åˆ’ç±»å‹</label>
                    <select class="signal-type" required style="font-size: 14px; padding: 8px 10px;">
                        <option value="time" ${type === 'time' ? 'selected' : ''}>æ—¶é—´æé†’</option>
                        <option value="price" ${type === 'price' ? 'selected' : ''}>ä»·æ ¼æé†’</option>
                    </select>
                </div>
                ${typeSpecificFields}
                <div class="form-group">
                    <label style="font-size: 12px;">æè¿°</label>
                    <input type="text" class="signal-desc" value="${description}" placeholder="ä¾‹å¦‚ï¼šæé†’å–å‡ºã€ç›®æ ‡ä»·ä½ç­‰" required style="font-size: 14px; padding: 8px 10px;">
                </div>
                ${triggered ? `<input type="hidden" class="signal-triggered" value="true">` : ''}
            `;
            
            signalsContainer.appendChild(signalDiv);
            
            // åŠ¨æ€åˆ‡æ¢ç±»å‹
            const typeSelect = signalDiv.querySelector('.signal-type');
            const container = signalDiv.querySelector('.signal-type').closest('.form-group');
            
            typeSelect.addEventListener('change', function() {
                const currentFields = signalDiv.querySelector('.signal-target').closest('.form-group, .form-row');
                if (currentFields) {
                    currentFields.remove();
                }
                
                if (this.value === 'time') {
                    const timeInput = document.createElement('div');
                    timeInput.className = 'form-group';
                    timeInput.innerHTML = `
                        <label style="font-size: 12px;">æé†’æ—¶é—´</label>
                        <input type="datetime-local" class="signal-target" value="" required style="font-size: 14px; padding: 8px 10px;">
                    `;
                    container.after(timeInput);
                } else {
                    const priceRow = document.createElement('div');
                    priceRow.className = 'form-row';
                    priceRow.innerHTML = `
                        <div class="form-group">
                            <label style="font-size: 12px;">æ¡ä»¶</label>
                            <select class="signal-condition" required style="font-size: 14px; padding: 8px 10px;">
                                <option value=">">å¤§äº</option>
                                <option value="<">å°äº</option>
                                <option value=">=">å¤§äºç­‰äº</option>
                                <option value="<=">å°äºç­‰äº</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label style="font-size: 12px;">ç›®æ ‡ä»·æ ¼</label>
                            <input type="number" step="0.01" class="signal-target" value="" required style="font-size: 14px; padding: 8px 10px;">
                        </div>
                    `;
                    container.after(priceRow);
                }
            });
            
            // åˆ é™¤æŒ‰é’®
            const removeBtn = signalDiv.querySelector('.remove-signal-btn');
            removeBtn.addEventListener('click', () => {
                signalDiv.remove();
                const allSignals = signalsContainer.querySelectorAll('.signal-inputs');
                allSignals.forEach((sig, index) => {
                    sig.querySelector('h4').textContent = `è®¡åˆ’ #${index + 1}`;
                });
                signalCount = allSignals.length;
            });
        }

        function savePlan() {
            const stockName = document.getElementById('stockName').value.trim();
            const stockCode = document.getElementById('stockCode').value.trim();
            const currentPriceInput = document.getElementById('currentPrice').value.trim();
            const notes = document.getElementById('notes').value.trim();
            
            const signals = [];
            const signalInputs = signalsContainer.querySelectorAll('.signal-inputs');
            
            signalInputs.forEach(input => {
                const type = input.querySelector('.signal-type').value;
                const target = input.querySelector('.signal-target').value.trim();
                const description = input.querySelector('.signal-desc').value.trim();
                const triggeredInput = input.querySelector('.signal-triggered');
                const triggered = triggeredInput ? triggeredInput.value === 'true' : false;
                
                if (type === 'time') {
                    if (target && description) {
                        signals.push({ 
                            type, 
                            target, 
                            description, 
                            triggered 
                        });
                    }
                } else {
                    const condition = input.querySelector('.signal-condition').value;
                    if (target && description) {
                        signals.push({ 
                            type, 
                            target: parseFloat(target), 
                            condition, 
                            description, 
                            triggered 
                        });
                    }
                }
            });
            
            if (!stockName || !stockCode || signals.length === 0) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µå¹¶è‡³å°‘æ·»åŠ ä¸€ä¸ªæœ‰æ•ˆçš„äº¤æ˜“è®¡åˆ’');
                return;
            }
            
            // è®¾ç½®åˆå§‹ä»·æ ¼ï¼ˆå¦‚æœæ²¡æœ‰è¾“å…¥ä»·æ ¼ï¼Œåˆ™è®¾ç½®ä¸º0ï¼Œè¡¨ç¤ºæœªè·å–ï¼‰
            const initialPrice = currentPriceInput ? parseFloat(currentPriceInput) : 0;
            const priceAvailable = currentPriceInput ? true : false;
            
            if (isEditing) {
                const planId = parseInt(document.getElementById('planId').value);
                const planIndex = tradingPlans.findIndex(p => p.id === planId);
                
                if (planIndex !== -1) {
                    tradingPlans[planIndex] = {
                        ...tradingPlans[planIndex],
                        stockName,
                        stockCode,
                        currentPrice: initialPrice,
                        priceAvailable: priceAvailable,
                        signals,
                        notes,
                        lastUpdated: new Date()
                    };
                }
            } else {
                const newPlan = {
                    id: tradingPlans.length > 0 ? Math.max(...tradingPlans.map(p => p.id)) + 1 : 1,
                    stockName,
                    stockCode,
                    currentPrice: initialPrice,
                    priceAvailable: priceAvailable,
                    status: "interested",
                    signals,
                    notes,
                    createdAt: new Date(),
                    lastUpdated: new Date(),
                    dataSource: priceAvailable ? 'initial' : 'unavailable',
                    history: [
                        {
                            status: "interested",
                            time: new Date(),
                            price: initialPrice,
                            priceAvailable: priceAvailable,
                            action: "åˆ›å»ºè®¡åˆ’",
                            signals: []
                        }
                    ]
                };
                
                tradingPlans.push(newPlan);
            }
            
            savePlansToStorage();
            renderPlans();
            closeModal();
            showNotification(`å·²${isEditing ? 'æ›´æ–°' : 'åˆ›å»º'} ${stockName} çš„äº¤æ˜“è®¡åˆ’`);
        }

        function closeModal() {
            planModal.style.display = 'none';
            historyModal.style.display = 'none';
        }

        // ================ äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ– ================
        document.getElementById('addPlanBtn').addEventListener('click', openAddModal);
        document.getElementById('addSignalBtn').addEventListener('click', () => addSignalInput());
        document.getElementById('savePlanBtn').addEventListener('click', savePlan);
        document.getElementById('cancelBtn').addEventListener('click', closeModal);
        document.getElementById('closeHistoryBtn').addEventListener('click', closeModal);
        updatePricesBtn.addEventListener('click', updateRealStockPrices);
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentFilter = tab.getAttribute('data-filter');
                renderPlans();
            });
        });
        
        window.addEventListener('click', (e) => {
            if (e.target === planModal || e.target === historyModal) {
                closeModal();
            }
        });

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                openAddModal();
            } else if (e.key === 'Escape') {
                closeModal();
            } else if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                updateRealStockPrices();
            }
        });

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            loadPlansFromStorage();
            setupAutoUpdateTimer();
            renderPlans();
            
            // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡æ—¶é—´ä¿¡å·
            setInterval(checkTimeSignals, 10000);
            
            // æ¯30ç§’æ›´æ–°ä¸€æ¬¡æ˜¾ç¤ºæ—¶é—´
            setInterval(updateLastUpdateTime, 30000);
            
            showNotification('äº¤æ˜“è®¡åˆ’å·¥å…·å·²åŠ è½½å®Œæˆï¼å¿«æ·é”®: Ctrl+Nåˆ›å»ºè®¡åˆ’, Ctrl+Ræ›´æ–°è‚¡ä»·');
        });

        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ›´æ–°
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                updateLastUpdateTime();
                checkTimeSignals();
            }
        });

    </script>
</body>
</html>